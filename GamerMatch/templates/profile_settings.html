{% extends "base.html" %}

{% load static %}

{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/profile_settings.css' %}"/>
{% endblock %}

{% block title %} Profile settings {% endblock %}

{% block navbarButton %}
    <div>
        <a href={% url 'profile_settings' %}>
            <div class="profile_icon"> <img src="../static/img/profile_icon.png" alt="profile_icon"> </div>
        </a>
        <a href={% url 'logout' %}>
            <div class="profile_icon"> <img src="../static/img/logout_icon.png" alt="logout_icon"></div>
        </a>
    </div>

{% endblock %}

{% block content %}
<div class="section_title">Tu perfil</div>
<div class="profile_nav"> <!--labels-->
    <div class="inactive_tab profile_nav_tab" id="tab_ajustes_de_cuenta">
        Ajustes de Cuenta
    </div>
    <div class="inactive_tab profile_nav_tab" id="tab_juegos_favoritos">
        Juegos favoritos
    </div>
    <div class="inactive_tab profile_nav_tab" id="tab_tags_favoritos">
        Tags favoritos
    </div>
</div>

<div  class="active_content"><!--Content div, with possible contents. The one that is selected -->
    <div id="body_ajustes_de_cuenta" class="inactive_content">
        <form method="post" id="change_password_form" action="{% url 'change_password' %}">  <!--Cambiar contraseña-->
            {% csrf_token %}

            <div class="content_body">
                <div class="row centered">
                    <div class="text_label">Nombre de Usuario:</div> <div class="text_value">{{ user }}</div>
                </div> <br>
                <div class="text_label row centered">Cambiar contraseña:</div><br><br>
                <div>
                    <div class="row spaced">
                        <label for="old_pass" class="text_label">Contraseña Antigua: </label> <input type="password" name="old_password" id="old_pass">
                    </div>
                    <div class="row spaced">
                        <label for="new_pass" class="text_label">Contraseña Nueva: </label> <input type="password" name="new_password1" id="new_pass">
                    </div>
                    <div class="row spaced">
                        <label for="new_pass2" class="text_label">Confirmar Contraseña: </label> <input type="password" name="new_password2" id="new_pass2">
                    </div>
                </div>
                {% if messages %}
                    <div>
                        {% for message in messages %}
                            <small {% if message.tags %} class="{{message.tags}}" {% endif %}>{{message}}</small>
                        {% endfor %}
                    </div>
                {% endif %}
                 <button type="button" id="change_password_form_btn" class="change_pass_button">Cambiar Contraseña</button>
            </div>
        </form>

    </div>

    <div id="body_juegos_favoritos" class="inactive_content">
        <form method="post" id="favorite_games_form" action="{% url 'update_favorite_games' %}">
            {% csrf_token %}

            <div class="content_body" >  <!--Juegos Favoritos-->
            <div>
                <div class="item_row">
                    <input type="checkbox" id="lol_checkbox" name="lol_game" class="star_checkbox">  <!--Checkbox-->
                    <label for="lol_checkbox" class="image_icon">
                        <img src="../static/img/lol.png">  <!--Game Icon-->
                    </label>

                    <div class="description_whiteboard">  <!--Description-->
                        League of Legends
                    </div>
                </div>
                <div class="item_row">
                    <input type="checkbox" id="minecraft_checkbox" name="minecraft_game" class="star_checkbox">  <!--Checkbox-->
                    <label for="minecraft_checkbox" class="image_icon">
                        <img src="../static/img/minecraft.png" >  <!--Game Icon-->
                    </label>

                    <div class="description_whiteboard">  <!--Description-->
                        Minecraft
                    </div>
                </div>
                <div class="item_row">
                    <input type="checkbox" id="smash_checkbox" name="smash_game" class="star_checkbox">
                    <label for="smash_checkbox" class="image_icon">
                        <img src="../static/img/smash.png">  <!--Game Icon-->
                    </label>

                    <div class="description_whiteboard">  <!--Description-->
                        Super Smash Bros. Ultimate
                    </div>
                </div>
            </div>
        </div>
        </form>
    </div>

    <div id="body_tags_favoritos" class="inactive_content">
        <div class="tag_favoritos_body" >  <!--Tags Favoritos-->
            <form method="post" id="tags_form">
                {% csrf_token %}
                <div class="tag_boxes_row">
                    <label for="new_tags" class="tag_box_label">Nuevos tags:</label>
                    <input type="text" data-role="tagsinput" class="tag_input" name="tags" id="new_tags">
                    <button type="button" class="add_tag_button" id="add_tag_button">Agregar</button>
                </div>
            </form>
            <div class="tag_boxes_row">
                <div class="tag_box_label">Tus tags: </div>
                <div class="whiteboard">
                    <!--
                    <div class="sticker">
                        <div>#flamer</div> <div class="close_icon"><img alt="close-icon" src="../static/img/icon-close-512.webp"></div>
                    </div>
                    <div class="sticker">
                        <div>#challenger</div> <div class="close_icon"><img alt="close-icon" src="../static/img/icon-close-512.webp"></div>
                    </div>
                    <div class="sticker">
                        <div>#help</div> <div class="close_icon"><img alt="close-icon" src="../static/img/icon-close-512.webp"></div>
                    </div>
                    <div class="sticker">
                        <div>#rick</div> <div class="close_icon"><img alt="close-icon" src="../static/img/icon-close-512.webp"></div>
                    </div>
                    <div class="sticker">
                        <div>#roll</div> <div class="close_icon"><img alt="close-icon" src="../static/img/icon-close-512.webp"></div>
                    </div>
                    <div class="sticker">
                        <div>#xd</div> <div class="close_icon"><img alt="close-icon" src="../static/img/icon-close-512.webp"></div>
                    </div>
                    -->
                </div>
            </div>
        </div>

    </div>

</div>

<script src="{% static 'js/profile_settings_tab_manager.js' %}"> </script>
<script>
    let csrfcookie = function() {
        let cookieValue = null,
            name = 'csrftoken';
        if (document.cookie && document.cookie !== '') {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                // search in the cookies, that whoe that has 'csrftoken' in its name
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    // Change password form
    let submit_change_psw_button = document.getElementById('change_password_form_btn');
    submit_change_psw_button.addEventListener('click', function () {
        let new_pass = document.getElementsByName('new_password1')[0].value;
        let new_pass_confirm = document.getElementsByName('new_password2')[0].value;

        if (new_pass !== new_pass_confirm) {
            console.log("Error, la nueva contraseña no coincide al confirmarla");
        } else {
            // this form must reload the page, to update the session cookie, using ajax here would complicate things.
            console.log("cambiando contraseña");
            document.getElementById('change_password_form').submit();  // submit and reload.

            /* let data = new FormData();
            data.append('old_password', document.getElementsByName('old_password')[0].value);
            data.append('new_password1', document.getElementsByName('new_password1')[0].value);
            data.append('new_password2', document.getElementsByName('new_password2')[0].value);

            let xhrequest = new XMLHttpRequest();
            xhrequest.open('POST', "{% url 'change_password' %}");
            xhrequest.timeout = 1000;
            xhrequest.withCredentials = true;
            // xhrequest.setRequestHeader("x-csrf-token", "fetch")
            xhrequest.setRequestHeader('X-CSRFToken', csrfcookie());
            xhrequest.onload = function (d) {
               //let responseText = d.currentTarget.responseText;
               alert('enviado!!, '+d.currentTarget.responseText);
            }
            xhrequest.onerror = function () {
               alert('Falló el envio del formulario :c');
            }
            xhrequest.send(data);
            */
        }
        return false;
        })

    // Change favorite games form
    let submit_change_fv_games_form = document.getElementById('favorite_games_form');
    submit_change_fv_games_form.addEventListener('change', function () {
        /*
        When the form changes, is instantly submited without reloading the page.
        The form changes when a checkbox is pressed. It's like the 'like' button on social medias.
        */
        let data = new FormData();
        data.append('lol_game', document.getElementById('lol_checkbox').value);
        data.append('minecraft_game', document.getElementById('minecraft_checkbox').value);
        data.append('smash_game', document.getElementById('smash_checkbox').value);

        let xhrequest = new XMLHttpRequest();
        xhrequest.open('POST', "{% url 'update_favorite_games' %}");
        xhrequest.setRequestHeader('X-CSRFToken', csrfcookie());
        xhrequest.timeout = 100;
        xhrequest.onload = function (d) {
            alert('response:'+d.currentTarget.responseText);
            console.log(d.currentTarget.responseText);
        }
        xhrequest.onerror = function (d) {
            alert('Failed');
        }
        xhrequest.send(data);

        return false;
    })

    // Add tags form
    let submit_tags_button = document.getElementById('add_tag_button');
    submit_tags_button.addEventListener('click', function () {
        let form = document.getElementById('tags_form');
        if (document.getElementById('new_tags').value !== '') {
            console.log("Se enviará la entrada");
            /*

            let xhrequest = new XMLHttpRequest();
            xhrequest.open('POST', '/change_password');
            xhrequest.timeout = 1000;
            xhrequest.onload = function (d) {
               //let responseText = d.currentTarget.responseText;
               alert('enviado!!');
            }
            xhrequest.onerror = function () {
               alert('Falló el envio del formulario :c');
            }
            xhrequest.send(data); */
            // form.submit();
        } else {
            console.log("Error, la entrada de tags está vacía");
        }
        return false;
    });


</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
{#<script src="{% static 'js/tagsinput.js'%}"></script>#}

{% endblock %}